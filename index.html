<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sports Day Attendance</title>

<style>
body{font-family:Arial;background:#f4f6f9;padding:15px}
.container{max-width:420px;background:#fff;margin:auto;padding:20px;border-radius:12px}
h2{text-align:center}
input,button{width:100%;padding:10px;margin-top:8px;font-size:15px}
button{background:#2563eb;color:#fff;border:none;border-radius:6px}
video,canvas{width:100%;border-radius:8px;margin-top:10px}
.status{margin-top:10px;font-weight:bold}
.ok{color:green}
.err{color:red}
small{color:#555}
</style>
</head>

<body>

<div class="container">
<h2>Sports Day Attendance</h2>

<button onclick="startVerification()">‚ñ∂ Start Verification</button>

<video id="video" playsinline muted hidden></video>
<canvas id="canvas" hidden></canvas>

<input id="name" placeholder="Student Name" required>
<input id="email" type="email" placeholder="Email" required>
<input id="className" placeholder="Class" required>
<input id="phone" placeholder="Phone (10 digits)" required>

<button onclick="verifyLocation()">üìç Verify Location</button>

<div class="status" id="time">üïí Time: Waiting‚Ä¶</div>
<div class="status" id="location">üìç Location: <span class="err">Not verified</span></div>
<div class="status" id="photo">üì∑ Photo: Waiting‚Ä¶</div>

<button id="submitBtn" onclick="submitForm()" disabled>Submit</button>
</div>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCJRIc1DTx7lARrtYx6QNx3bjWKna2t3OL_K-t7m_Z_cF7Mn_RPFrb4N3z6zZuRrFT/exec";

/* ================= CAMPUSES ================= */
const CAMPUSES = [
  { lat:28.676370, lon:77.112480, r:300 }, // BVIMR
  { lat:28.675120, lon:77.113860, r:300 }, // BVICAM
  { lat:28.678520, lon:77.111930, r:300 }  // BVCOE
];

let photoData = "";
let timeText = "";
let allowed = false;

/* ================= START ================= */
async function startVerification(){
  captureTime();
  await startCamera();
  setTimeout(capturePhoto, 2000);
}

/* ================= FRONT CAMERA ================= */
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"user" }
  });
  video.srcObject = stream;
  video.hidden = false;
  await video.play();
}

/* ================= PHOTO ================= */
function capturePhoto(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  canvas.hidden = false;
  photoData = canvas.toDataURL("image/png");
  photo.innerHTML = "üì∑ Photo: <span class='ok'>Captured</span>";
  checkReady();
}

/* ================= TIME ================= */
function captureTime(){
  timeText = new Date().toLocaleString();
  time.innerHTML = "üïí Time: " + timeText;
}

/* ================= DISTANCE (METERS) ================= */
function distance(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ================= LOCATION (FIXED & WORKING) ================= */
function verifyLocation(){
  if(!navigator.geolocation){
    location.innerHTML = "‚ùå <span class='err'>GPS not supported</span>";
    allowed = false;
    checkReady();
    return;
  }

  location.innerHTML = "üìç Checking location‚Ä¶";
  allowed = false;

  navigator.geolocation.getCurrentPosition(
    pos=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const accuracy = pos.coords.accuracy || 50; // meters, default to 50 if undefined

      console.log("GPS Position:", { lat, lon, accuracy });
      
      allowed = false;
      let closestDistance = Infinity;
      let closestCampus = null;

      for(const c of CAMPUSES){
        const d = distance(lat, lon, c.lat, c.lon);
        console.log(`Campus check: distance=${Math.round(d)}m, radius=${c.r}m, accuracy=${Math.round(accuracy)}m`);
        
        if(d < closestDistance){
          closestDistance = d;
          closestCampus = c;
        }

        // ‚úÖ LENIENT LOGIC: Account for GPS accuracy uncertainty
        // Allow if distance is within (radius + accuracy + buffer)
        // This ensures users inside campus are verified even with GPS inaccuracy
        const buffer = 100; // Extra buffer for GPS variations and building interference
        const effectiveRadius = c.r + accuracy + buffer;
        
        if (d <= effectiveRadius) {
          allowed = true;
          console.log("‚úÖ Location verified! Distance:", Math.round(d), "Effective radius:", Math.round(effectiveRadius));
          break;
        }
      }

      if(allowed){
        location.innerHTML =
          "‚úÖ <span class='ok'>Location Verified</span><br>" +
          "<small>Distance: " + Math.round(closestDistance) + " m, Accuracy: " + Math.round(accuracy) + " m</small>";
      } else {
        location.innerHTML =
          "‚ùå <span class='err'>Location not verified</span><br>" +
          "<small>Distance: " + Math.round(closestDistance) + " m, Accuracy: " + Math.round(accuracy) + " m</small><br>" +
          "<small>Required: within " + (closestCampus ? closestCampus.r : 350) + " m radius</small>";
      }

      checkReady();
    },
    (err)=>{
      console.error("Geolocation error:", err);
      let errorMsg = "‚ùå <span class='err'>Location error: ";
      switch(err.code){
        case err.PERMISSION_DENIED:
          errorMsg += "Permission denied</span>";
          break;
        case err.POSITION_UNAVAILABLE:
          errorMsg += "Position unavailable</span>";
          break;
        case err.TIMEOUT:
          errorMsg += "Request timeout</span>";
          break;
        default:
          errorMsg += "Unknown error</span>";
          break;
      }
      location.innerHTML = errorMsg;
      allowed = false;
      checkReady();
    },
    {
      enableHighAccuracy:true,
      timeout:25000,
      maximumAge:0
    }
  );
}

/* ================= READY ================= */
function checkReady(){
  submitBtn.disabled = !(photoData && allowed);
}

/* ================= SUBMIT ================= */
function submitForm(){

  if(
    !name.value.trim() ||
    !email.value.trim() ||
    !className.value.trim() ||
    !phone.value.match(/^[0-9]{10}$/) ||
    !photoData ||
    !allowed
  ){
    alert("All fields required and location must be verified");
    return;
  }

  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      name:name.value.trim(),
      email:email.value.trim(),
      className:className.value.trim(),
      phone:phone.value.trim(),
      datetime:timeText,
      location:"Location Verified",
      photo:photoData
    })
  })
  .then(()=>alert("‚úÖ Attendance Submitted"))
  .catch(()=>alert("‚ùå Submission failed"));
}
</script>

</body>
</html>
