<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Campus Restricted Student Form</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  padding:15px;
}
.container{
  max-width:420px;
  background:#fff;
  margin:auto;
  padding:20px;
  border-radius:12px;
}
h2{text-align:center}
input,button{
  width:100%;
  padding:10px;
  margin-top:8px;
  font-size:15px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:6px;
}
video,canvas{
  width:100%;
  border-radius:8px;
  margin-top:10px;
}
.status{
  margin-top:10px;
  font-weight:bold;
  font-size:14px;
}
.allowed{color:green}
.blocked{color:red}
</style>
</head>

<body>

<div class="container">
<h2>Student Verification</h2>

<button onclick="startVerification()">‚ñ∂ Start Verification</button>

<video id="video" playsinline muted hidden></video>
<canvas id="canvas" hidden></canvas>

<input id="name" placeholder="Name" required>
<input id="email" type="email" placeholder="Email" required>
<input id="className" placeholder="Class" required>
<input id="phone" pattern="[0-9]{10}" placeholder="Phone" required>

<div class="status" id="time">üïí Time: Waiting</div>
<div class="status" id="location">üìç Verifying location‚Ä¶</div>
<div class="status" id="photo">üì∑ Photo: Waiting</div>

<button id="submitBtn" onclick="submitForm()" disabled>Submit</button>
</div>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL = "PASTE_SCRIPT_URL_HERE";

/* ================= GEOFENCE DATA ================= */
const CAMPUSES = [
  { name:"BVIMR College, Paschim Vihar, Delhi", lat:28.676370, lon:77.112480, r:200 },
  { name:"BVICAM College, Paschim Vihar, Delhi", lat:28.675120, lon:77.113860, r:200 },
  { name:"BVCOE College, Paschim Vihar, Delhi",  lat:28.678520, lon:77.111930, r:200 }
];

let photoData = "";
let locationText = "";
let timeText = "";
let allowed = false;

/* ================= START FLOW ================= */
async function startVerification(){
  await startCamera();
  captureTime();
  captureLocation();
  setTimeout(capturePhoto, 2500); // auto photo after 2.5 sec
}

/* ================= FRONT CAMERA ================= */
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"user" } // FRONT CAMERA
  });
  video.srcObject = stream;
  video.hidden = false;
  await video.play();
}

/* ================= PHOTO ================= */
function capturePhoto(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  canvas.hidden = false;
  photoData = canvas.toDataURL("image/png");
  photo.innerText = "üì∑ Photo: Captured";
  checkReady();
}

/* ================= TIME ================= */
function captureTime(){
  timeText = new Date().toLocaleString();
  time.innerText = "üïí Time: " + timeText;
}

/* ================= DISTANCE (METERS) ================= */
function distance(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ================= LOCATION + GEOFENCE ================= */
function captureLocation(){
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      allowed = false;
      locationText = "";

      for(const c of CAMPUSES){
        if(distance(lat, lon, c.lat, c.lon) <= c.r){
          allowed = true;
          locationText = c.name;
          break;
        }
      }

      if(allowed){
        location.innerHTML =
          "üìç Location Verified: <span class='allowed'>" + locationText + "</span>";
      }else{
        location.innerHTML =
          "‚ùå Not inside BVIMR / BVICAM / BVCOE (200m)";
      }

      checkReady();
    },
    ()=>{
      location.innerHTML = "‚ùå Location permission denied";
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

/* ================= READY CHECK ================= */
function checkReady(){
  if(photoData && allowed){
    submitBtn.disabled = false;
  }
}

/* ================= SUBMIT ================= */
function submitForm(){
  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      name: name.value,
      email: email.value,
      className: className.value,
      phone: phone.value,
      datetime: timeText,
      location: locationText,
      photo: photoData
    })
  })
  .then(()=>alert("‚úÖ Submitted Successfully"))
  .catch(()=>alert("‚ùå Submission Failed"));
}
</script>

</body>
</html>
